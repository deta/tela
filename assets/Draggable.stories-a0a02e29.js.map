{"version":3,"file":"Draggable.stories-a0a02e29.js","sources":["../../src/lib/Draggable.svelte","../../src/stories/DraggableStory.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { createEventDispatcher, getContext } from \"svelte\";\n  import type { Vec2 } from \"./types/Utils.type.js\";\n  import type { Writable } from \"svelte/store\";\n  import type { TBoard, TBoardSettings } from \"./types/Board.type.js\";\n  import { hasClassOrParentWithClass, snapToGrid } from \"./utils.js\";\n\n  export let pos: Vec2;\n  export let size: Vec2;\n\n  const dispatch = createEventDispatcher();\n\n  const board = getContext<Writable<TBoard>>(\"board\");\n  const settings = getContext<Writable<TBoardSettings>>(\"settings\");\n\n  let dragState = {\n    init: { x: 0, y: 0 },\n    curr: { x: 0, y: 0 },\n    offset: { x: 0, y: 0 }\n  };\n\n  // Utils\n  function posToViewportPos(x: number, y: number) {\n    return {\n      x: x - $board.viewPort.x,\n      y: y - $board.viewPort.y + window.scrollY\n    };\n  }\n\n  // UI Handlers\n  function onMouseDown(e: MouseEvent | TouchEvent) {\n    const target = (e as TouchEvent).targetTouches?.item(0)?.target || (e as MouseEvent).target;\n    const { x: clientX, y: clientY } = posToViewportPos(\n      (e as TouchEvent).targetTouches?.item(0)?.clientX || (e as MouseEvent).clientX,\n      (e as TouchEvent).targetTouches?.item(0)?.clientY || (e as MouseEvent).clientY\n    );\n\n    if (hasClassOrParentWithClass(target as HTMLElement, \"tela-ignore\")) return;\n    e.stopPropagation();\n    document.body.classList.add(\"dragging\");\n    // let cX = e.clientX;\n    // let cY = e.clientY;\n    // todo: handle touch\n\n    const x = $settings.SNAP_TO_GRID ? snapToGrid(clientX, $settings.GRID_SIZE!) : clientX;\n    const y = $settings.SNAP_TO_GRID ? snapToGrid(clientY, $settings.GRID_SIZE!) : clientY;\n\n    dragState.init = { x, y };\n    dragState.curr = { x, y };\n\n    document.addEventListener(\"mousemove\", onMouseMove);\n    document.addEventListener(\"mouseup\", onMouseUp, { once: true });\n    document.addEventListener(\"touchmove\", onMouseMove);\n    document.addEventListener(\"touchend\", onMouseUp, { once: true });\n\n    dispatch(\"dragStart\", { pos });\n  }\n\n  function onMouseMove(e: MouseEvent | TouchEvent) {\n    const { x: clientX, y: clientY } = posToViewportPos(\n      (e as TouchEvent).targetTouches?.item(0)?.clientX || (e as MouseEvent).clientX,\n      (e as TouchEvent).targetTouches?.item(0)?.clientY || (e as MouseEvent).clientY\n    );\n\n    dragState.offset = {\n      x: (clientX - dragState.curr.x) / $board.zoom,\n      y: (clientY - dragState.curr.y) / $board.zoom\n    };\n\n    dragState.curr = { x: clientX, y: clientY };\n\n    // todo: optimize setting pos?\n\n    const newX = pos.x + dragState.offset.x;\n    const newY = pos.y + dragState.offset.y;\n\n    if ($settings.BOUNDS?.minX !== null && newX < $settings.BOUNDS!.minX) {\n      pos.x = $settings.BOUNDS!.minX;\n    } else if ($settings.BOUNDS?.maxX !== null && newX + size.x > $settings.BOUNDS!.maxX) {\n      pos.x = $settings.BOUNDS!.maxX - size.x;\n    } else {\n      pos.x += dragState.offset.x;\n    }\n\n    if ($settings.BOUNDS?.minY !== null && newY < $settings.BOUNDS!.minY) {\n      pos.y = $settings.BOUNDS!.minY;\n    } else if ($settings.BOUNDS?.maxY !== null && newY + size.y > $settings.BOUNDS!.maxY) {\n      pos.y = $settings.BOUNDS!.maxY - size.y;\n    } else {\n      pos.y += dragState.offset.y;\n    }\n\n    dispatch(\"dragMove\", { pos, offset: dragState.offset });\n  }\n\n  function onMouseUp(e: MouseEvent | TouchEvent) {\n    document.body.classList.remove(\"dragging\");\n    document.removeEventListener(\"mousemove\", onMouseMove);\n    document.removeEventListener(\"touchmove\", onMouseMove);\n    dispatch(\"dragEnd\", { pos });\n  }\n</script>\n\n<svelte:element\n  this=\"div\"\n  {...$$restProps}\n  class=\"draggable {$$restProps.class || ''}\"\n  on:mousedown={onMouseDown}\n  on:touchstart|nonpassive={onMouseDown}\n>\n  <slot />\n</svelte:element>\n","<script lang=\"ts\">\n  import Board from \"$lib/Board.svelte\";\n  import Positionable from \"$lib/Positionable.svelte\";\n  import Draggable from \"$lib/Draggable.svelte\";\n  import type { TBoard, TBoardSettings, Vec2 } from \"$lib/index.js\";\n  import { writable } from \"svelte/store\";\n\n  export let pos: Vec2 = { x: 0, y: 0 };\n  export let size: Vec2 = { x: 100, y: 100 };\n\n  const settings = writable({} satisfies TBoardSettings);\n\n  const board = writable({\n    viewOffset: { x: 0, y: 0 },\n    zoom: 1\n  } satisfies TBoard);\n\n  const element = { pos, size };\n  const el2 = { pos: { x: 200, y: 200 }, size: { x: 100, y: 100 } };\n</script>\n\n<main class=\"draggableStory\">\n  <Board {settings} {board}>\n    <Positionable pos={element.pos} size={element.size} z={1}>\n      <Draggable bind:pos={element.pos} bind:size={element.size}>\n      drag here.\n      </Draggable>\n      Positionable\n    </Positionable>\n    <Positionable pos={el2.pos} size={el2.size} z={1}>\n      <Draggable bind:pos={el2.pos} bind:size={el2.size}>\n      drag here.\n      </Draggable>\n      Positionable\n    </Positionable>\n  </Board>\n</main>\n\n<style>\n  main {\n    height: 500px;\n  }\n  :global(.draggableStory .draggable) {\n    background: lightgray;\n  }\n</style>"],"names":["ctx","insert_hydration","target","div","anchor","div_class_value","pos","$$props","size","dispatch","createEventDispatcher","board","getContext","settings","dragState","posToViewportPos","x","y","$board","onMouseDown","e","_b","_a","clientX","clientY","_d","_c","_f","_e","hasClassOrParentWithClass","$settings","snapToGrid","onMouseMove","onMouseUp","newX","newY","$$invalidate","_g","_h","draggable_props","draggable_changes","dirty","positionable0_changes","positionable1_changes","main","writable","element","el2","$$self","value"],"mappings":"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"}